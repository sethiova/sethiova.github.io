---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  lang?: 'es' | 'en';
}

const { title, description = "Max Dev Portfolio", lang = 'es' } = Astro.props;

const navTranslations = {
  es: {
    about: 'Sobre mÃ­',
    experience: 'Experiencia',
    projects: 'Proyectos',
    contact: 'Contactar'
  },
  en: {
    about: 'About',
    experience: 'Experience',
    projects: 'Projects',
    contact: 'Contact'
  }
};

const t = navTranslations[lang];
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body>
    <div class="background-glow"></div>
    <div class="background-glow-2"></div>
    
    <nav class="navbar">
      <div class="container nav-content">
        <a href="#" class="logo">Max<span class="text-gradient">.Dev</span></a>
        <ul class="nav-links">
          <li><a href="#about">{t.about}</a></li>
          <li><a href="#experience">{t.experience}</a></li>
          <li><a href="#projects">{t.projects}</a></li>
          
          <!-- Social Links -->
          <li class="social-links-nav">
             <a href="https://github.com/sethiova" target="_blank" aria-label="GitHub">GitHub</a>
             <span class="separator">/</span>
             <a href="https://www.linkedin.com/in/maximiliano-mendoza-dev/" target="_blank" aria-label="LinkedIn">LinkedIn</a>
          </li>
          
          <!-- Controls -->
          <li class="controls-group">
            <!-- Theme Toggle -->
            <button id="theme-toggle" class="control-btn" aria-label="Cambiar Tema" title="Cambiar Tema">
              <span id="theme-icon">ðŸŽ¨</span>
              <span class="tooltip">Original</span>
            </button>

            <!-- Language Toggle -->
            <button id="lang-toggle" class="control-btn" aria-label="Cambiar Idioma" title="Switch Language">
              <span id="lang-text">{lang.toUpperCase()}</span>
            </button>
          </li>

          <li><a href="#contact" class="btn btn-primary contact-btn">{t.contact}</a></li>
        </ul>
      </div>
    </nav>

    <slot />

    <footer class="footer">
      <div class="container">
        <p>&copy; {new Date().getFullYear()} Max Dev. {lang === 'es' ? 'Hecho con Astro' : 'Made with Astro'} ðŸš€.</p>
      </div>
    </footer>
    <!-- Lightbox Structure -->
    <div id="lightbox" class="lightbox">
      <span class="lightbox-close">&times;</span>
      <span class="lightbox-prev">&#10094;</span>
      <img class="lightbox-content" id="lightbox-img" src="" alt="Zoomed Image">
      <span class="lightbox-next">&#10095;</span>
    </div>

    <script is:inline>
      document.addEventListener('astro:page-load', () => {
        initLightbox();
        initGalleryNav();
      });

      document.addEventListener('DOMContentLoaded', () => {
        initLightbox();
        initGalleryNav();
      });

      let activeGalleryIntervals = [];

      function initGalleryNav() {
        // Cleanup old intervals on re-run
        activeGalleryIntervals.forEach(clearInterval);
        activeGalleryIntervals = [];

        document.querySelectorAll('.image-gallery').forEach(gallery => {
          // Check if already wrapped to prevent duplicate wrapping on re-renders
          if (gallery.parentElement.classList.contains('gallery-wrapper')) return;

          const images = gallery.querySelectorAll('img');
          if (images.length <= 1) return; // No need for nav if simple image

          // Create wrapper
          const wrapper = document.createElement('div');
          wrapper.classList.add('gallery-wrapper');
          
          // Insert wrapper before gallery
          gallery.parentNode.insertBefore(wrapper, gallery);
          
          // Move gallery into wrapper
          wrapper.appendChild(gallery);

          // Create Buttons
          const prevBtn = document.createElement('button');
          prevBtn.innerHTML = '&#10094;';
          prevBtn.classList.add('gallery-nav-btn', 'gallery-prev-btn');

          const nextBtn = document.createElement('button');
          nextBtn.innerHTML = '&#10095;';
          nextBtn.classList.add('gallery-nav-btn', 'gallery-next-btn');

          // Add events
          prevBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (gallery.scrollLeft <= 20) {
               gallery.scrollTo({ left: gallery.scrollWidth, behavior: 'auto' });
            } else {
               gallery.scrollBy({ left: -gallery.clientWidth, behavior: 'smooth' });
            }
          });

          nextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (gallery.scrollLeft + gallery.clientWidth >= gallery.scrollWidth - 20) {
               gallery.scrollTo({ left: 0, behavior: 'auto' });
            } else {
               gallery.scrollBy({ left: gallery.clientWidth, behavior: 'smooth' });
            }
          });

          wrapper.appendChild(prevBtn);
          wrapper.appendChild(nextBtn);

          // Auto Slide Logic
          let intervalId;
          const startAutoSlide = () => {
             clearInterval(intervalId);
             intervalId = setInterval(() => {
                 nextBtn.click();
             }, 5000);
             activeGalleryIntervals.push(intervalId);
          };

          const stopAutoSlide = () => {
             clearInterval(intervalId);
          };

          wrapper.addEventListener('mouseenter', stopAutoSlide);
          wrapper.addEventListener('mouseleave', startAutoSlide);
          
          // Initial start
          startAutoSlide();
        });
      }

      function initLightbox() {
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const closeBtn = document.querySelector('.lightbox-close');
        const prevBtn = document.querySelector('.lightbox-prev');
        const nextBtn = document.querySelector('.lightbox-next');
        let currentGalleryImages = [];
        let currentIndex = 0;

        // Open Lightbox
        document.querySelectorAll('.project-img').forEach(img => {
          // Remove old listeners to avoid duplicates if re-init? 
          // Better: check if listener attached? Hard to do.
          // Native 'click' duplicates are fine if functions are identical? No.
          // Workaround: cloning node or simple flag.
          if (img.dataset.lightboxAttached) return;
          img.dataset.lightboxAttached = "true";

          img.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const gallery = img.closest('.image-gallery');
            
            if (gallery) {
              currentGalleryImages = Array.from(gallery.querySelectorAll('.project-img'));
              currentIndex = currentGalleryImages.indexOf(img);
            } else {
              currentGalleryImages = [img];
              currentIndex = 0;
            }

            updateLightboxImage();
            lightbox.classList.add('active');
            updateNavButtons();
          });
        });

        // Close Lightbox
        function closeLightbox() {
          lightbox.classList.remove('active');
          currentGalleryImages = []; // Reset
        }

        closeBtn.addEventListener('click', closeLightbox);
        
        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) {
            closeLightbox();
          }
        });

        // Navigation
        function updateLightboxImage() {
          if (currentGalleryImages.length > 0) {
            const currentImg = currentGalleryImages[currentIndex];
            lightboxImg.src = currentImg.src;
            lightboxImg.alt = currentImg.alt;
          }
        }

        function updateNavButtons() {
          if (currentGalleryImages.length <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
          } else {
            prevBtn.style.display = 'block';
            nextBtn.style.display = 'block';
          }
        }

        function showNext() {
          if (currentGalleryImages.length > 1) {
            currentIndex = (currentIndex + 1) % currentGalleryImages.length;
            updateLightboxImage();
          }
        }

        function showPrev() {
          if (currentGalleryImages.length > 1) {
            currentIndex = (currentIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
            updateLightboxImage();
          }
        }

        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showNext();
        });

        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showPrev();
        });

        // Keyboard support
        document.addEventListener('keydown', (e) => {
          if (!lightbox.classList.contains('active')) return;
          
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowRight') showNext();
          if (e.key === 'ArrowLeft') showPrev();
        });
      }
    </script>
  </body>
</html>

<style>
  /* Ambient Background */
  .background-glow {
    position: fixed;
    top: -20%;
    left: -20%;
    width: 60%;
    height: 60%;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, rgba(15, 23, 42, 0) 70%);
    z-index: -1;
    pointer-events: none;
  }
  
  .background-glow-2 {
    position: fixed;
    bottom: -20%;
    right: -20%;
    width: 60%;
    height: 60%;
    background: radial-gradient(circle, rgba(236, 72, 153, 0.1) 0%, rgba(15, 23, 42, 0) 70%);
    z-index: -1;
    pointer-events: none;
  }

  /* Navbar */
  .navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: var(--nav-bg); 
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 1000;
    border-bottom: 1px solid var(--glass-border);
    transition: background 0.3s ease;
  }

  .nav-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
  }

  .logo {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-main);
  }

  .nav-links {
    display: flex;
    list-style: none;
    gap: 1.5rem;
    align-items: center;
    padding: 0;
    margin: 0;
  }

  .nav-links a:not(.btn) {
    color: var(--color-text-muted);
    font-weight: 500;
    font-size: 0.95rem;
    transition: color 0.3s;
  }

  .nav-links a:not(.btn):hover {
    color: var(--color-primary);
  }

  .social-links-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-right: 0.5rem;
    border-left: 1px solid rgba(255,255,255,0.1);
    padding-left: 1.5rem;
  }

  .separator {
    color: var(--color-text-muted);
    font-size: 0.8rem;
  }

  /* Controls (Theme & Lang) */
  .controls-group {
    display: flex;
    gap: 0.8rem;
    background: rgba(255, 255, 255, 0.03);
    padding: 0.3rem 0.6rem;
    border-radius: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .control-btn {
    background: transparent;
    border: none;
    color: var(--color-text-main);
    padding: 0.4rem;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 36px;
    height: 36px;
    position: relative;
  }

  .control-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--color-primary);
    transform: rotate(15deg);
  }

  .control-btn .tooltip {
    position: absolute;
    top: 120%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-surface);
    color: var(--color-text-main);
    padding: 0.2rem 0.6rem;
    border-radius: 0.3rem;
    font-size: 0.75rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    border: 1px solid var(--glass-border);
    white-space: nowrap;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .control-btn:hover .tooltip {
    opacity: 1;
  }

  .contact-btn {
    padding: 0.5rem 1.2rem; 
    font-size: 0.9rem;
    margin-left: 0.5rem;
  }

  /* Footer */
  .footer {
    padding: 2rem 0;
    text-align: center;
    margin-top: auto;
    border-top: 1px solid rgba(255,255,255,0.05);
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .nav-links {
        gap: 0.8rem;
    }
    .social-links-nav, .separator {
        display: none; /* Hide social text links on mobile to save space */
    }
    .controls-group {
        padding: 0.2rem;
    }
  }
</style>

<script>
  // Elements
  const themeBtn = document.getElementById('theme-toggle');
  const themeIcon = document.getElementById('theme-icon');
  const themeTooltip = themeBtn?.querySelector('.tooltip');
  
  // Config
  const themes = [
    { name: 'original', icon: 'ðŸŽ¨', label: 'Original' }, 
    { name: 'light', icon: 'â˜€ï¸', label: 'Light' }, 
    { name: 'dark', icon: 'ðŸŒ™', label: 'Dark' }
  ];
  
  let currentThemeIndex = 0;

  // Initialize
  function updateThemeUI(index) {
    const theme = themes[index];
    
    // Set Attribute
    if (theme.name === 'original') {
      document.documentElement.removeAttribute('data-theme');
    } else {
      document.documentElement.setAttribute('data-theme', theme.name);
    }

    // Update Icon & Label
    if (themeIcon) themeIcon.textContent = theme.icon;
    if (themeTooltip) themeTooltip.textContent = theme.label;
  }

  // Load saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    const savedIndex = themes.findIndex(t => t.name === savedTheme);
    if (savedIndex !== -1) {
        currentThemeIndex = savedIndex;
        updateThemeUI(currentThemeIndex);
    }
  }

  // Event Listener Theme
  themeBtn?.addEventListener('click', () => {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    const newTheme = themes[currentThemeIndex];
    updateThemeUI(currentThemeIndex);
    localStorage.setItem('theme', newTheme.name);
  });

  // Language Logic is simpler: just redirect
  const langBtn = document.getElementById('lang-toggle');
  
  langBtn?.addEventListener('click', () => {
    const currentPath = window.location.pathname;
    if (currentPath.startsWith('/en')) {
      const newPath = currentPath.replace('/en', '') || '/';
      window.location.href = newPath;
    } else {
      const newPath = '/en' + (currentPath === '/' ? '' : currentPath);
      window.location.href = newPath;
    }
  });
</script>
